name: Run UI tests (dispatch)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'ui'

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_type == 'ui' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-recording

      - name: Install Chrome + ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip xvfb ffmpeg
          wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y /tmp/chrome.deb || sudo apt --fix-broken install -y
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1,2)
          LATEST=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION || true)
          [ -z "$LATEST" ] && LATEST=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE)
          wget -q -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$LATEST/chromedriver_linux64.zip"
          unzip -qq /tmp/chromedriver.zip -d /tmp
          sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Prepare display and start recording
        env:
          DISPLAY: :99
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 >/tmp/xvfb.log 2>&1 &
          sleep 2
          ffmpeg -y -video_size 1920x1080 -framerate 15 -f x11grab -i :99 -codec:v libx264 -preset ultrafast /tmp/session.mp4 >/tmp/ffmpeg.log 2>&1 &
          echo "Recording started"

      - name: Run pytest (UI tests)
        env:
          DISPLAY: :99
        run: |
          mkdir -p artifacts/screenshots
          pytest tests -k "ui or UI or browser" --maxfail=1 -q || true
          cp -r test-results artifacts/ 2>/dev/null || true

      - name: Stop recording
        run: |
          pkill -f ffmpeg || true
          pkill -f Xvfb || true
          mv /tmp/session.mp4 ./artifacts/ || true

      - name: Zip artifacts
        run: zip -r artifacts.zip artifacts || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-artifacts
          path: artifacts.zip
