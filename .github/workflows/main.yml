name: Run UI tests (dispatch)

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'ui'

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_type == 'ui' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-recording

      - name: Install Chrome + ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip xvfb ffmpeg
          wget -q -O /tmp/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y /tmp/chrome.deb || sudo apt --fix-broken install -y
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1,2)
          LATEST=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION || true)
          [ -z "$LATEST" ] && LATEST=$(curl -sS chromedriver.storage.googleapis.com/LATEST_RELEASE)
          wget -q -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/$LATEST/chromedriver_linux64.zip"
          unzip -qq /tmp/chromedriver.zip -d /tmp
          sudo mv /tmp/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Prepare display and start recording
        env:
          DISPLAY: :99
        run: |
          export DISPLAY
